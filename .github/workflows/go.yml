# Ø¢Ø¯Ø±Ø³ ÙØ§ÛŒÙ„: .github/workflows/update-v2ray.yml

name: Update V2Ray Configs

# Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù…Ø´Ø®Øµ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ú¯Ø±Ø¯Ø´ Ú©Ø§Ø± Ú†Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯
on:
  # 1. Ù‡Ø± Ø¨Ø§Ø± Ú©Ù‡ Ú©Ø¯ÛŒ Ø¨Ù‡ Ø´Ø§Ø®Ù‡ main Ù¾ÙˆØ´ Ø´ÙˆØ¯ (Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ ÙÙˆØ±ÛŒ Ø¨Ø¹Ø¯ Ø§Ø² ØªØºÛŒÛŒØ±Ø§Øª)
  push:
    branches:
      - main
      
  # 2. Ø¨Ù‡ ØµÙˆØ±Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø´Ø¯Ù‡ (Ù‡Ø± 20 Ø¯Ù‚ÛŒÙ‚Ù‡ ÛŒÚ© Ø¨Ø§Ø±)
  schedule:
    - cron: "*/20 * * * *"

  # 3. Ù‚Ø§Ø¨Ù„ÛŒØª Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ Ø§Ø² Ø·Ø±ÛŒÙ‚ ØªØ¨ Actions Ø¯Ø± Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨
  workflow_dispatch:

permissions:
  contents: write # ÙÙ‚Ø· Ø¨Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ù†ÙˆØ´ØªÙ† Ù†ÛŒØ§Ø² Ø¯Ø§Ø±Ø¯

jobs:
  update-configs:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        cache: true

    - name: Build and run Go aggregator
      run: |
        cd Files
        echo "Building Go application..."
        go mod tidy
        go build -ldflags="-s -w" -o ../aggregator *.go
        cd ..
        echo "Starting config aggregation, sorting, and renaming..."
        ./aggregator
        echo "Config processing completed successfully!"
      
    - name: Verify output files
      run: |
        echo "Verifying generated files..."
        ls -la *.txt 2>/dev/null || echo "No .txt files found in root"
        
    - name: Create status summary
      run: |
        echo "# V2Ray Config Update Summary" > UPDATE_SUMMARY.md
        echo "Generated on: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> UPDATE_SUMMARY.md
        
        total=0
        if [ -f "All_Configs_Sub.txt" ]; then
          total=$(wc -l < "All_Configs_Sub.txt")
        fi
        echo "- Total configurations: $total" >> UPDATE_SUMMARY.md

    - name: Commit and push changes
      uses: EndBug/add-and-commit@v9
      with:
        author_name: "GitHub Actions Bot"
        author_email: "actions-bot@github.com"
        message: "ðŸš€ Fresh V2Ray Configs Update"
        add: "."
        default_author: github_actor
